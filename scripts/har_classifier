import pandas as pd

# Import reusable_classifier and the reader
from dtsc330 import classifier
from dtsc330.readers import har
har.HAR('data/motion-and-heart-rate-from-a-wrist-worn-wearable-and-labeled-sleep-from-polysomnography-1.0.0')


"""
features: 
- heartrates & their accelerations ('acc_x/y/z')
- mean heartrate by test subject (8 hour window containing awake and asleep heartrates)
- take absolute value, then mean acceleration over the same window
"""

# read in the data, assign a variable
# convert to df (makes it easier going forward)
har_data = har.HAR('data/motion-and-heart-rate-from-a-wrist-worn-wearable-and-labeled-sleep-from-polysomnography-1.0.0')
har_df = har_data.df


# pulling absolute values
# negative numbers will affect the mean amounts
har_df['acc_x'] = har_df['acc_x'].abs()
har_df['acc_y'] = har_df['acc_y'].abs()
har_df['acc_z'] = har_df['acc_z'].abs()

# this will determine how many samples exist for one
# subject 
window_size = 50
window_size2 = 250

# this will help approximate one subject's entire 
# recording ... which will give us the mean heart rate over
# an 8-hour window. (both awake and not awake)
# then overwrite the dataframe so it only includes
# the rolled values 
har_df['rolling_hr'] = har_df['hr'].rolling(window = window_size).mean()
har_df['rolling_acc_x'] = har_df['acc_x'].rolling(window = window_size).mean()
har_df['rolling_acc_y'] = har_df['acc_y'].rolling(window = window_size).mean()
har_df['rolling_acc_z'] = har_df['acc_z'].rolling(window = window_size).mean()
df = har_df[har_df['rolling_hr'].isna() == False]

print('rolling_hr')

# utilize important parts of data frame
# this will time stamp to about one row per second. 
# there will not be many changes in less than this
df = har_df.iloc[::250]

# train test split
labels = df['is_sleep']
features = df.drop(columns = ['rolling_hr', 'rolling_acc_x', 'rolling_acc_y', 'rolling_acc_z', 'rolling_acc_hr_12hr'])

rc = classifier.ReusableClassifier(model_type = 'random_forest')

# print(df[df['person'] == 0.0].head())
# assess ( from classifier file )
# print(rc.assess(features, labels))